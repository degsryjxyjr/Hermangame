<!DOCTYPE html>
<html>
<head>
    <title>Game Lobby</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body onload="populateClassList()">
    <div id="joinView">
        <h2>Join Game</h2>
        <div class="input-group">
            <label>Room Code:</label>
            <input type="text" id="roomCodeInput" placeholder="Enter room code">
        </div>
        <div class="input-group">
            <label>Your Name:</label>
            <input type="text" id="nameInput" placeholder="Your player name">
        </div>
        <div class="input-group">
            <label>Class:</label>
            <select id="classSelect">
            </select>
        </div>

        <button onclick="joinGame()">Join Game</button>
    </div>

    <div id="lobbyView">
        <h2>Room: <span id="roomCodeDisplay"></span></h2>
        <div id="playerList"></div>
        <button id="readyButton" onclick="toggleReady()">Ready Up</button>
        <button id="startButton" onclick="startGame()" disabled>Start Game</button>
        <button onclick="disconnect()">Leave Lobby</button>
    </div>
    <div id="gameView">
        <!-- Inventory Button (floating action button for mobile) -->
        <button id="inventoryButton" class="fab">
            <img src="images/icons/backpack.jpg" alt="Inventory">
        </button>
        
        <!-- Inventory Panel -->
        <div id="inventoryPanel">
            <div class="inventory-header">
                <h3>Inventory</h3>
                <button id="closeInventory">Ã—</button>
            </div>
            <div id="equippedSection">
                <h4>Equipped</h4>
                <div id="equippedItems" class="equipped-grid">
                    <!-- Equipped items will be populated here -->
                    <!-- Example slot placeholders (optional) -->
                    <!--
                    <div class="equipped-slot" data-slot="Weapon"><span class="slot-name">Weapon</span></div>
                    <div class="equipped-slot" data-slot="Armor"><span class="slot-name">Armor</span></div>
                    <div class="equipped-slot" data-slot="Accessory"><span class="slot-name">Accessory</span></div>
                    -->
                </div>
            </div>
            <hr> <!-- Separator -->
            <div id="bagSection">
                <h4>Bag</h4>
                <div id="inventoryItems" class="inventory-grid">
                    <!-- Bag items will be populated here -->
                </div>
            </div>
        </div>
    </div>
    <div id="debugLog">Connecting...</div>

    <script>
        let ws;
        let currentPlayerId;
        let isReady = false;
        let debugInterval;
        let roomCode = '';
        /* ---- INVENTORY UI ---- */
        const inventoryButton = document.getElementById('inventoryButton');
        const inventoryPanel   = document.getElementById('inventoryPanel');
        const closeInventory   = document.getElementById('closeInventory');
        const inventoryItems   = document.getElementById('inventoryItems');
        let inventoryData      = [];

        // --- Ensure your existing toggleInventory function requests the full update ---
        function toggleInventory() {
            const panel = document.getElementById('inventoryPanel');
            const isVisible = panel.style.display === 'block';
            panel.style.display = isVisible ? 'none' : 'block';
            if (!isVisible) { // If we are opening the panel
                sendMessage({ type: "inventory", action: "get" }); // Request full inventory data
            }
        }

        // Proper event listeners
        document.getElementById('inventoryButton').addEventListener('click', function(e) {
            e.preventDefault();
            toggleInventory();
        });

        document.getElementById('closeInventory').addEventListener('click', function(e) {
            e.preventDefault();
            toggleInventory();
        });

        // Handle clicks outside inventory content
        document.getElementById('inventoryPanel').addEventListener('click', function(e) {
            if (e.target === this) { // Clicked on backdrop
                toggleInventory();
            }
        });

        function handleInventoryData(inventoryUpdateData) {
            // --- Handle Bag Items (existing logic, slightly modified) ---
            const bagItems = inventoryUpdateData.items || []; // Ensure it's an array
            const bagContainer = document.getElementById('inventoryItems');
            bagContainer.innerHTML = ''; // Clear existing items

            if (bagItems.length === 0) {
                bagContainer.innerHTML = '<div class="empty-inventory">Your bag is empty</div>';
            } else {
                bagItems.forEach(item => {
                    const itemEl = createInventoryItemElement(item); // Reuse item creation logic
                    // Add click listener for using items from the bag
                    itemEl.addEventListener('click', () => {
                        sendMessage({ type: "inventory", action: "use", itemId: item.id });
                    });
                    bagContainer.appendChild(itemEl);
                });
            }

            // --- Handle Equipped Items (NEW LOGIC) ---
            const equippedData = inventoryUpdateData.equipped || {}; // Ensure it's an object
            const equippedContainer = document.getElementById('equippedItems');
            equippedContainer.innerHTML = ''; // Clear existing slots/items

            // Define your expected equipment slots (order matters for display)
            // Make sure these match the enum names used in C# (ItemDefinition.EquipmentSlot)
            const equipmentSlotOrder = ['MainHand', 'OffHand', 'Head', 'Body', 'Accessory'];

            equipmentSlotOrder.forEach(slotName => {
                const itemData = equippedData[slotName]; // Get item data for this slot, if any

                // Create a container for the slot
                const slotEl = document.createElement('div');
                slotEl.className = 'equipped-slot'; // Base class for styling
                slotEl.dataset.slot = slotName; // Store slot name for potential future use

                if (itemData) {
                    // Slot is filled
                    slotEl.classList.add('filled');

                    // Create the equipped item element (similar to bag item)
                    const equippedItemEl = createInventoryItemElement(itemData);

                    // Optional: Add specific class or behavior for equipped items
                    equippedItemEl.classList.add('equipped-item');

                    // Add click listener to potentially unequip or show details
                    // Here, we'll use the "equip" action, which should toggle it off
                    // according to your C# logic (PlayerInventory.EquipItem)
                    equippedItemEl.addEventListener('click', () => {
                        sendMessage({ type: "inventory", action: "equip", itemId: itemData.id });
                        // Or send "use" if that's the intended way to toggle equipment
                        // sendMessage({ type: "inventory", action: "use", itemId: itemData.id });
                    });

                    // Clear default content and add the item
                    slotEl.innerHTML = '';
                    slotEl.appendChild(equippedItemEl);

                } else {
                    // Slot is empty
                    // Display the slot name or an empty indicator
                    const slotNameEl = document.createElement('span');
                    slotNameEl.className = 'slot-name';
                    slotNameEl.textContent = slotName;
                    slotEl.appendChild(slotNameEl);
                    // You might add a visual "empty slot" icon here too if desired
                }

                equippedContainer.appendChild(slotEl);
            });

            // --- Show the inventory panel if it's not already visible ---
            // (This part was already handled by toggleInventory calling this function)
        }
        // --- Helper function to create an inventory item element ---
        // This avoids duplicating the creation logic for bag and equipped items
        function createInventoryItemElement(item) {
            const itemEl = document.createElement('div');
            itemEl.className = 'inventory-item'; // Or 'equipped-item' if you want different base styles

            // --- Create the image element ---
            const imgEl = document.createElement('img');
            imgEl.alt = item.name || 'Item';
            imgEl.className = 'item-icon';

            // --- Implement PNG/JPG fallback logic ---
            let basePath = item.icon || 'images/icons/default-item.jpg';
            if (basePath === 'images/icons/default-item.jpg') {
                imgEl.src = basePath;
            } else {
                imgEl.src = `${basePath}.png`;
                imgEl.onerror = function () {
                    console.warn(`Failed to load PNG icon: ${this.src}. Trying JPG...`);
                    this.src = `${basePath}.jpg`;
                    this.onerror = function () {
                        console.warn(`Failed to load JPG icon: ${this.src}. Loading default.`);
                        this.src = 'images/icons/default-item.jpg';
                    };
                };
            }

            // --- Create name element ---
            const nameEl = document.createElement('span');
            nameEl.className = 'item-name';
            nameEl.textContent = item.name || 'Unknown Item';

            // --- Create quantity element (if applicable and > 1) ---
            let quantityEl = null;
            if (item.quantity && item.quantity > 1) {
                quantityEl = document.createElement('span');
                quantityEl.className = 'item-quantity';
                quantityEl.textContent = item.quantity;
            }

            // --- Assemble the item element ---
            itemEl.appendChild(imgEl);
            itemEl.appendChild(nameEl);
            if (quantityEl) {
                itemEl.appendChild(quantityEl);
            }

            return itemEl;
        }
        /* ---- INVENTORY UI END---- */

        function logDebug(message) {
            const debugElement = document.getElementById('debugLog');
            debugElement.innerHTML += `${new Date().toLocaleTimeString()}: ${message}<br>`;
            debugElement.scrollTop = debugElement.scrollHeight;
        }

        function populateClassList() {
            fetch('/api/classes')
                .then(r => r.json())
                .then(classes => {
                    const sel = document.getElementById('classSelect');
                    sel.innerHTML = '';
                    classes.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.className;
                        opt.textContent = c.className;
                        opt.dataset.icon = c.iconPath;  // Store the icon path if needed
                        sel.appendChild(opt);
                    });
                    logDebug(`Loaded ${classes.length} classes`);
                })
                .catch(err => logDebug(`Failed to load classes: ${err}`));
        }

        function joinGame() {
            roomCode = document.getElementById('roomCodeInput').value.trim();
            const name = document.getElementById('nameInput').value.trim();
            const className = document.getElementById('classSelect').value;

            if (!roomCode || !name) {
                logDebug("Please enter room code and name");
                return alert("Please enter room code and name");
            }

            logDebug(`Connecting to room ${roomCode} as ${name} (${className})...`);
            
            ws = new WebSocket(`ws://${window.location.hostname}:9000/game`);

            ws.onopen = () => {
                ws.send(JSON.stringify({
                    type: "join",
                    roomCode: roomCode,
                    name: name,
                    class: className 
                }));
            };

            ws.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                handleServerMessage(msg);
            };

            ws.onclose = () => {
                logDebug("Disconnected from server");
                document.getElementById('joinView').style.display = 'block';
                document.getElementById('lobbyView').style.display = 'none';
            };

            ws.onerror = (err) => {
                logDebug(`WebSocket error: ${err.message}`);
            };
        }

        function handleServerMessage(msg) {
            switch(msg.type) {
                case "join_success":
                    currentPlayerId = msg.playerId;
                    document.getElementById('roomCodeDisplay').textContent = roomCode;
                    document.getElementById('joinView').style.display = 'none';
                    document.getElementById('lobbyView').style.display = 'block';
                    logDebug(`Joined successfully as ${msg.profile.name}`);
                    break;
                    
                case "join_error":
                    logDebug(`Join failed: ${msg.message}`);
                    alert(msg.message);
                    break;
                    
                case "lobby_update":
                    updatePlayerList(msg.players);
                    document.getElementById('startButton').disabled = !msg.canStart;
                    logDebug(`Player list updated (${msg.players.length} players)`);
                    break;
                case "game_state_change":
                    switch (msg.state) {
                        case "Map":
                            document.getElementById('lobbyView').style.display = 'none';
                            document.getElementById('gameView').style.display = 'block';
                            // Ensure inventory is hidden when game starts
                            document.getElementById('inventoryPanel').style.display = 'none';
                            break;
                        case "Lobby":
                            document.getElementById('gameView').style.display = 'none';
                            document.getElementById('lobbyView').style.display = 'block';
                            break;
                        // add other states if you need them
                    }
                    break;

                case "inventory_update":
                    // Pass the entire message object, not just msg.items
                    handleInventoryData(msg);
                    break;

                default:
                    logDebug(`Unknown message type: ${msg.type}`);
            }
        }
        /* helper to send WS messages */
        function sendMessage(payload) {
            if (ws && ws.readyState === 1) ws.send(JSON.stringify(payload));
        }
        function updatePlayerList(players) {
            const listElement = document.getElementById('playerList');
            listElement.innerHTML = '';
            
            players.forEach(player => {
                const entry = document.createElement('div');
                entry.className = `player-entry ${player.IsReady ? 'ready' : ''}`;
                
                const playerInfo = document.createElement('div');
                playerInfo.className = 'player-info';
                playerInfo.innerHTML = `
                    <span><b>${player.Name}</b></span>
                    <span>${player.Role}</span>
                    <span>${player.IsReady ? 'READY' : 'waiting'}</span>
                `;
                
                entry.appendChild(playerInfo);
                listElement.appendChild(entry);
            });
        }

        function toggleReady() {
            isReady = !isReady;
            const message = {
                type: "set_ready",
                isReady: isReady
            };
            console.log("Sending ready message:", message);
            ws.send(JSON.stringify(message));
            document.getElementById('readyButton').textContent = isReady ? "Unready" : "Ready Up";
            logDebug(`Set ready state to ${isReady}`);
        }

        function startGame() {
            ws.send(JSON.stringify({ type: "start_game" }));
            logDebug("Sent start game request");
        }

        function disconnect() {
            if (ws) {
                logDebug("Disconnecting...");
                ws.close();
            }
        }

        debugInterval = setInterval(() => {
            if (ws) {
                logDebug(`Connection state: ${ws.readyState}`);
            }
        }, 5000);
    </script>
</body>
</html>