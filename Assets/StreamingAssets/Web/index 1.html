<!DOCTYPE html>
<html>
<head>
    <title>Game Lobby</title>
    <style>
        body { font-family: sans-serif; max-width: 500px; margin: 0 auto; padding: 20px; }
        .input-group { margin: 10px 0; }
        input, select { padding: 8px; width: 100%; box-sizing: border-box; }
        button { padding: 8px 15px; margin: 5px; cursor: pointer; }
        #lobbyView { display: none; }
        .player-entry { display: flex; margin: 5px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .ready { background-color: #dfd; }
        #debugLog { margin-top: 20px; padding: 10px; background: #f5f5f5; border-radius: 4px; font-family: monospace; }
        .player-info { display: flex; justify-content: space-between; width: 100%; }
    </style>
</head>
<body>
    <div id="joinView">
        <h2>Join Game</h2>
        <div class="input-group">
            <label>Room Code:</label>
            <input type="text" id="roomCodeInput" placeholder="Enter room code">
        </div>
        <div class="input-group">
            <label>Your Name:</label>
            <input type="text" id="nameInput" placeholder="Your player name">
        </div>
        <div class="input-group">
            <label>Class:</label>
            <select id="classSelect">
                <!-- Will be populated dynamically -->
            </select>
        </div>

        <button onclick="joinGame()">Join Game</button>
    </div>

    <div id="lobbyView">
        <h2>Room: <span id="roomCodeDisplay"></span></h2>
        <div id="playerList"></div>
        <button id="readyButton" onclick="toggleReady()">Ready Up</button>
        <button id="startButton" onclick="startGame()" disabled>Start Game</button>
        <button onclick="disconnect()">Leave Lobby</button>
    </div>

    <div id="debugLog">Connecting...</div>

    <script>
        let ws;
        let currentPlayerId;
        let isReady = false;
        let debugInterval;
        let roomCode = '';

        function logDebug(message) {
            const debugElement = document.getElementById('debugLog');
            debugElement.innerHTML += `${new Date().toLocaleTimeString()}: ${message}<br>`;
            debugElement.scrollTop = debugElement.scrollHeight;
        }
        function populateClassList() {
            fetch('/api/classes')
                .then(response => response.json())
                .then(classes => {
                    const select = document.getElementById('classSelect');
                    select.innerHTML = '';
                    
                    classes.forEach(cls => {
                        const option = document.createElement('option');
                        option.value = cls.className;
                        option.textContent = cls.className;
                        select.appendChild(option);
                    });
                });
        }
        function joinGame() {
            roomCode = document.getElementById('roomCodeInput').value.trim();
            const name = document.getElementById('nameInput').value.trim();
            const role = document.getElementById('classSelect').value;

            if (!roomCode || !name) {
                logDebug("Please enter room code and name");
                return alert("Please enter room code and name");
            }

            logDebug(`Connecting to room ${roomCode} as ${name} (${role})...`);
            
            ws = new WebSocket(`ws://${window.location.hostname}:9000/game`);

            ws.onopen = () => {
                //populating the class list
                populateClassList();
                ws.send(JSON.stringify({
                    type: "join",
                    roomCode: roomCode,
                    name: name,
                    role: role
                }));
            };

            ws.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                handleServerMessage(msg);
            };

            ws.onclose = () => {
                logDebug("Disconnected from server");
                document.getElementById('joinView').style.display = 'block';
                document.getElementById('lobbyView').style.display = 'none';
            };

            ws.onerror = (err) => {
                logDebug(`WebSocket error: ${err.message}`);
            };
        }

        function handleServerMessage(msg) {
            switch(msg.type) {
                case "join_success":
                    currentPlayerId = msg.playerId;
                    document.getElementById('roomCodeDisplay').textContent = roomCode;
                    document.getElementById('joinView').style.display = 'none';
                    document.getElementById('lobbyView').style.display = 'block';
                    logDebug(`Joined successfully as ${msg.profile.name}`);
                    break;
                    
                case "join_error":
                    logDebug(`Join failed: ${msg.message}`);
                    alert(msg.message);
                    break;
                    
                case "player_update":
                    updatePlayerList(msg.players);
                    document.getElementById('startButton').disabled = !msg.canStart;
                    logDebug(`Player list updated (${msg.players.length} players)`);
                    break;
                    
                case "game_starting":
                    logDebug("Game is starting!");
                    alert("Game is starting!");
                    break;
                    
                default:
                    logDebug(`Unknown message type: ${msg.type}`);
            }
        }

        function updatePlayerList(players) {
            const listElement = document.getElementById('playerList');
            listElement.innerHTML = '';
            
            players.forEach(player => {
                const entry = document.createElement('div');
                entry.className = `player-entry ${player.IsReady ? 'ready' : ''}`;
                
                const playerInfo = document.createElement('div');
                playerInfo.className = 'player-info';
                playerInfo.innerHTML = `
                    <span><b>${player.Name}</b></span>
                    <span>${player.Role}</span>
                    <span>${player.IsReady ? 'READY' : 'waiting'}</span>
                `;
                
                entry.appendChild(playerInfo);
                listElement.appendChild(entry);
            });
        }
        function toggleReady() {
            isReady = !isReady;
            const message = {
                type: "set_ready",
                isReady: isReady
            };
            console.log("Sending ready message:", message);
            ws.send(JSON.stringify(message));
            document.getElementById('readyButton').textContent = isReady ? "Unready" : "Ready Up";
            logDebug(`Set ready state to ${isReady}`);
        }

        function startGame() {
            ws.send(JSON.stringify({ type: "start_game" }));
            logDebug("Sent start game request");
        }

        function disconnect() {
            if (ws) {
                logDebug("Disconnecting...");
                ws.close();
            }
        }

        // Start debug logging
        debugInterval = setInterval(() => {
            if (ws) {
                logDebug(`Connection state: ${ws.readyState}`);
            }
        }, 5000);
    </script>
</body>
</html>